#!/bin/execlineb -P

backtick -E PCAPS { mktemp }
foreground {
	redirfd -w 1 ${PCAPS}
	pipeline -d { getpid -E PID getpcaps ${PID} }
	pipeline -d { awk "{print $NF}" }
	pipeline -d { tr "," "\n" }
	s6-sort
}
backtick -E RCAPS { mktemp }
foreground {
	redirfd -w 1 ${RCAPS}
	pipeline -d { s6-echo "cap_mknod,cap_net_admin" }
	pipeline -d { tr "," "\n" }
	s6-sort
}
backtick -E ACAPS { mktemp }
foreground { redirfd -w 1 ${ACAPS} grep -o -f ${RCAPS} ${PCAPS} }
if -nt { cmp -s ${ACAPS} ${RCAPS} }
foreground {
	backtick -E MCAPS {
		pipeline -d { grep -v -f ${ACAPS} ${RCAPS} } xargs
	}
	fdmove -c 1 2
	s6-echo "[ERROR] Linux capabilities are missing: ${MCAPS}"
}
exit 1
